<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>/v1/resolve Tester</title>
  <style>
    :root { --bg:#0b0f14; --panel:#121821; --muted:#7a8699; --text:#e6eef7; --accent:#6aa5ff; --warn:#ffcc66; --err:#ff6b6b; --ok:#59d499; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
    header { padding: 16px 20px; background: #0e141d; border-bottom: 1px solid #1d2735; }
    h1 { font-size: 18px; margin: 0; }
    .container { max-width: 920px; margin: 0 auto; padding: 20px; }
    .card { background: var(--panel); border: 1px solid #1d2735; border-radius: 12px; padding: 16px; margin-bottom: 16px; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input { width: 100%; padding: 10px 12px; background: #0e141d; color: var(--text); border: 1px solid #1d2735; border-radius: 8px; outline: none; }
    input:focus { border-color: var(--accent); }
    .row { display:flex; gap:12px; }
    .row > div { flex:1; }
    button { appearance: none; border: 0; border-radius: 10px; padding: 10px 14px; background: var(--accent); color: #061321; font-weight: 600; cursor: pointer; }
    button.secondary { background: #1d2735; color: var(--text); border:1px solid #243246; }
    .btns { display:flex; gap:8px; align-items:center; }
    .muted { color: var(--muted); }
    .status { font-size: 12px; }
    .status .ok { color: var(--ok); }
    .status .warn { color: var(--warn); }
    .status .err { color: var(--err); }
    pre { margin:0; white-space: pre-wrap; word-break: break-word; }
    code.block { display:block; background:#0f141d; border:1px solid #1d2735; border-radius:10px; padding:12px; font-size:12px; line-height:1.45; }
    .grid { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    @media (max-width: 800px){ .grid { grid-template-columns: 1fr; } .row { flex-direction: column; } }
    a { color: var(--accent); text-decoration: none; }
    .tiny { font-size: 11px; }
  </style>
</head>
<body>
  <header>
    <h1>/v1/resolve Tester</h1>
  </header>

  <div class="container">
    <div class="card">
      <div class="row">
        <div>
          <label>API Base URL</label>
          <input id="apiBase" placeholder="https://api.yourdomain.com" />
          <div class="tiny muted">Defaults to this page’s origin.</div>
        </div>
        <div style="max-width:220px">
          <label>Dealer</label>
          <input id="dealer" value="default" />
        </div>
      </div>
      <div style="height:8px"></div>
      <div>
        <label>Input (Dealer name or Google Maps URL with ?cid=…)</label>
        <input id="q" placeholder="Germain Toyota of Naples OR https://maps.google.com/?cid=123..." />
      </div>
      <div style="height:12px"></div>
      <div class="btns">
        <button id="runBtn">Resolve</button>
        <button class="secondary" id="copyBtn" title="Copy JSON" disabled>Copy JSON</button>
        <span class="status" id="status"></span>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <div class="muted tiny">Request</div>
        <code class="block" id="reqBlock"></code>
      </div>
      <div class="card">
        <div class="muted tiny">Response</div>
        <code class="block" id="resBlock"></code>
      </div>
    </div>

    <div class="card" id="quick">
      <div class="muted tiny">Quick Links</div>
      <div id="links"></div>
    </div>
  </div>

  <script>
    const apiBaseEl = document.getElementById('apiBase');
    const dealerEl = document.getElementById('dealer');
    const qEl = document.getElementById('q');
    const runBtn = document.getElementById('runBtn');
    const copyBtn = document.getElementById('copyBtn');
    const statusEl = document.getElementById('status');
    const reqBlock = document.getElementById('reqBlock');
    const resBlock = document.getElementById('resBlock');
    const linksEl = document.getElementById('links');

    // Defaults
    apiBaseEl.value = window.location.origin;

    function esc(s){ return String(s || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function fmtJSON(obj){ try { return JSON.stringify(obj, null, 2); } catch { return String(obj); } }
    function setStatus(html){ statusEl.innerHTML = html; }
    function clear(){ resBlock.textContent=''; linksEl.innerHTML=''; setStatus(''); copyBtn.disabled = true; }

    function countdown(sec){
      let left = sec;
      const id = setInterval(() => {
        left -= 1;
        if (left <= 0){ clearInterval(id); setStatus(''); }
        else setStatus(`<span class="warn">Rate limited.</span> Retry in ${left}s`);
      }, 1000);
    }

    async function run(){
      clear();
      const base = apiBaseEl.value.trim() || window.location.origin;
      const dealer = dealerEl.value.trim() || 'default';
      const input = qEl.value.trim();
      const url = `${base.replace(/\/+$/,'')}/v1/resolve?dealer=${encodeURIComponent(dealer)}&input=${encodeURIComponent(input)}`;

      reqBlock.textContent = url;

      const t0 = performance.now();
      let resp;
      try {
        resp = await fetch(url, { method: 'GET' });
      } catch (e){
        setStatus(`<span class="err">Network error</span>`);
        resBlock.textContent = String(e);
        return;
      }
      const dt = (performance.now() - t0).toFixed(0);

      const retryAfter = resp.headers.get('Retry-After');
      const reset = resp.headers.get('X-RateLimit-Reset');
      setStatus(`<span class="${resp.ok ? 'ok' : (resp.status===429 ? 'warn' : 'err')}">HTTP ${resp.status}</span> • ${dt}ms${retryAfter?` • Retry-After ${retryAfter}s`:''}`);

      let body;
      try {
        body = await resp.json();
      } catch {
        body = { error: 'Non-JSON response' };
      }

      resBlock.textContent = fmtJSON(body);
      copyBtn.disabled = false;

      // Quick links
      const links = [];
      if (body?.maps_url) links.push(`<a href="${esc(body.maps_url)}" target="_blank" rel="noopener">Open Google Maps</a>`);
      if (body?.website) links.push(`<a href="${esc(body.website)}" target="_blank" rel="noopener">Website</a>`);
      if (body?.place_id) links.push(`<a href="https://maps.google.com/?q=place_id:${esc(body.place_id)}" target="_blank" rel="noopener">View by place_id</a>`);
      linksEl.innerHTML = links.length ? links.join(" &nbsp;•&nbsp; ") : '<span class="muted tiny">None</span>';

      if (resp.status === 429 && retryAfter){
        countdown(parseInt(retryAfter, 10) || 60);
      }
    }

    runBtn.addEventListener('click', run);
    copyBtn.addEventListener('click', () => {
      try {
        navigator.clipboard.writeText(resBlock.textContent);
        setStatus('<span class="ok">JSON copied</span>');
        setTimeout(() => setStatus(''), 1200);
      } catch {}
    });

    // Enter to run
    qEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') run(); });
  </script>
</body>
</html>
